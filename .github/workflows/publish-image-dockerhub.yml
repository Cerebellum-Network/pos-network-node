name: Publish image to DockerHub
on:
  push:
    branches:
      - cere-master

env:
  REPO_NAME: cerebellum-network
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Checkout submodules
        run: git submodule update --init --recursive
      - name: "Print output"
        run: echo $GITHUB_WORKSPACE
      - name: Read name and version from Cargo.toml file
        id: read_toml
        uses: outcome-co/action-read-toml@master
        with:
          path: Cargo.toml
          key: |
            package.name
            package.version
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push image
        id: docker_build
        run: |
          docker build . -t $REPO_NAME/${{ steps.read_toml.outputs.package_name }}:${{ steps.read_toml.outputs.package_version }}
          docker push $REPO_NAME/${{ steps.read_toml.outputs.package_name }}:${{ steps.read_toml.outputs.package_version }}
      - name: Image digest
        run: echo ${{ steps.docker_build.outputs.digest }}
